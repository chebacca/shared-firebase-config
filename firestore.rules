rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // UNIFIED FIRESTORE SECURITY RULES - ALL PROJECTS
    // ============================================================================
    // Supports: Dashboard, Licensing Website, Call Sheet App, EDL Converter, Parser Brain
    // Handles all collections with proper organization-based access control
    // Single source of truth for all Firebase security rules
    // ============================================================================
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    // Authentication check
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user's custom claims
    function getUserClaims() {
      return request.auth.token;
    }
    
    // Get organization ID from user claims
    function getOrganizationId() {
      // Check if user has organizationId in custom claims
      let orgId = getUserClaims().get('organizationId', '');
      
      // If no organizationId in claims, check if it's a standalone user
      return orgId != '' ? orgId : 
        (request.auth.token.email == 'standalone.user@example.com' || 
         request.auth.token.email.matches('.*@example\\.com$')) ? 'standalone' : '';
    }
    
    // Check if user belongs to organization
    function belongsToOrganization(organizationId) {
      // Allow standalone users to access standalone organization
      return (organizationId == 'standalone' && 
              (request.auth.token.email == 'standalone.user@example.com' || 
               request.auth.token.email.matches('.*@example\\.com$'))) ||
             (isAuthenticated() && getOrganizationId() == organizationId);
    }
    
    // Check if user has specific role
    function hasRole(role) {
      return isAuthenticated() && getUserClaims().get('role', '') == role;
    }
    
    // Check if user has any of the specified roles
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserClaims().get('role', '') in roles;
    }
    
    // Check if user has organizational role
    function hasOrgRole(role) {
      return isAuthenticated() && getUserClaims().get('teamMemberRole', '') == role;
    }
    
    // Check if user has any organizational roles
    function hasAnyOrgRole(roles) {
      return isAuthenticated() && getUserClaims().get('teamMemberRole', '') in roles;
    }
    
    // Check if user is owner or admin
    function isOwnerOrAdmin() {
      return hasAnyRole(['OWNER', 'ADMIN', 'SUPERADMIN', 'SUPER_ADMIN']) || 
             hasAnyOrgRole(['owner', 'admin']) ||
             getUserClaims().get('isAdmin', false) ||
             getUserClaims().get('superAdmin', false) ||
             getUserClaims().get('canAccessAdminPanel', false);
    }
    
    // Check if user owns the document (userId field matches)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user can access project data
    function canAccessProject(projectId) {
      return isAuthenticated() && (
        // Check if user has project assignment
        projectId in getUserClaims().get('projectAssignments', {}) ||
        // Check if user belongs to organization (get from project data)
        belongsToOrganization(get(/databases/$(database)/documents/projects/$(projectId)).data.organizationId) ||
        // Allow standalone users
        getOrganizationId() == 'standalone' ||
        // Allow admin users to access all projects
        hasAnyRole(['ADMIN', 'SUPERADMIN', 'OWNER'])
      );
    }
    
    // Check if user can modify project data
    function canModifyProject(projectId) {
      return isAuthenticated() && (
        // Check if user is project admin
        projectId in getUserClaims().get('projectAssignments', {}) &&
        getUserClaims().get('projectAssignments', {})[projectId].get('baseRole', '') in ['ADMIN', 'DO_ER'] ||
        // Check if user has organization admin role
        hasAnyOrgRole(['admin', 'owner']) ||
        // Allow standalone users
        getOrganizationId() == 'standalone' ||
        // Allow admin users to modify all projects
        hasAnyRole(['ADMIN', 'SUPERADMIN', 'OWNER'])
      );
    }
    
    // Check if user has minimum hierarchy level
    function hasMinimumHierarchy(minLevel) {
      return isAuthenticated() && getUserClaims().get('effectiveHierarchy', 0) >= minLevel;
    }
    
    // Check if user has EDL Converter access
    function hasEDLConverterAccess() {
      return isAuthenticated() && getUserClaims().get('isEDLConverter', false);
    }
    
    // Check if user has Call Sheet access
    function hasCallSheetAccess() {
      return isAuthenticated() && getUserClaims().get('isCallSheetUser', false);
    }
    
    // Check if user is standalone user
    function isStandaloneUser() {
      return isAuthenticated() && getUserClaims().get('isStandaloneUser', false);
    }
    
    // Check if user has Clip Show Pro add-on access
    function hasClipShowProAccess() {
      return isAuthenticated() && (
        getUserClaims().get('subscriptionAddOns', {}).get('clipShowPro', false) ||
        'CLIP_SHOW_PRO' in getUserClaims().get('permissions', []) ||
        getUserClaims().get('clipShowProAccess', false) ||
        getUserClaims().get('isClipShowProUser', false) ||
        'clip_show_pro' in getUserClaims().get('permissions', []) ||
        getUserClaims().get('role', '') == 'ADMIN' ||
        getUserClaims().get('role', '') == 'SUPERADMIN'
      );
    }
    
    // ============================================================================
    // CROSS-APP SYNCHRONIZATION COLLECTIONS
    // ============================================================================
    
    // Role Sync Events - Cross-app role synchronization
    match /roleSyncEvents/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }
    
    // Project Assignments - Project assignment data
    match /projectAssignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        request.auth.uid == resource.data.userId ||
        canAccessProject(resource.data.projectId)
      );
      allow write: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }
    
    // ============================================================================
    // CORE COLLECTIONS
    // ============================================================================
    
    // Users - Core user data
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (request.auth.uid == userId || isOwnerOrAdmin());
    }
    
    // Organizations - Organization data
    match /organizations/{orgId} {
      allow read: if isAuthenticated() && belongsToOrganization(orgId);
      allow write: if isAuthenticated() && belongsToOrganization(orgId) && isOwnerOrAdmin();
      allow create: if isAuthenticated() && isOwnerOrAdmin();
      allow update: if isAuthenticated() && belongsToOrganization(orgId) && isOwnerOrAdmin();
    }
    
    // Team Members - Team member data
    match /teamMembers/{memberId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        request.auth.uid == resource.data.userId ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          request.auth.uid == resource.data.userId ||
          isOwnerOrAdmin()
        )
      );
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Project Team Members - Project-specific team member assignments
    match /projectTeamMembers/{assignmentId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        request.auth.uid == resource.data.teamMemberId ||
        canAccessProject(resource.data.projectId)
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          canModifyProject(resource.data.projectId) ||
          isOwnerOrAdmin()
        )
      );
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Project Participants - Project participant assignments (primary collection)
    match /project_participants/{participantId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        request.auth.uid == resource.data.userId ||
        canAccessProject(resource.data.projectId)
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          canModifyProject(resource.data.projectId) ||
          isOwnerOrAdmin()
        )
      );
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Project Datasets - Project-dataset linking
    match /project_datasets/{linkId} {
      allow read: if isAuthenticated() && (
        // User can read if they belong to the same organization as the project
        belongsToOrganization(resource.data.organizationId) ||
        // User can read if they have project access
        canAccessProject(resource.data.projectId) ||
        // Allow ADMIN role users to read all project datasets
        hasAnyRole(['ADMIN', 'SUPERADMIN', 'OWNER'])
      );
      allow write: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId) && isOwnerOrAdmin();
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Datasets - Dataset metadata
    match /datasets/{datasetId} {
      allow read: if isAuthenticated() && (
        // User can read if they own the dataset
        request.auth.uid == resource.data.ownerId ||
        // User can read if they belong to the same organization
        belongsToOrganization(resource.data.organizationId) ||
        // User can read if they have access to projects that use this dataset
        canAccessProject(resource.data.projectId) ||
        // Allow ADMIN role users to read all datasets
        hasAnyRole(['ADMIN', 'SUPERADMIN', 'OWNER'])
      );
      allow write: if isAuthenticated() && (
        // User can write if they own the dataset
        request.auth.uid == resource.data.ownerId ||
        // User can write if they have organization admin rights
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin())
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.ownerId ||
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin())
      );
    }
    
    // Projects - Project data
    match /projects/{projectId} {
      allow read: if canAccessProject(projectId);
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if canModifyProject(projectId);
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Sessions - Production sessions
    match /sessions/{sessionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canAccessProject(resource.data.projectId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canModifyProject(resource.data.projectId) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
    }
    
    // Network Delivery Bibles - Network delivery configurations
    match /networkDeliveryBibles/{bibleId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Timecards
    match /timecards/{timecardId} {
      allow read: if isOwner(resource.data.userId) || 
                     canAccessProject(resource.data.projectId);
      allow create: if canAccessProject(request.resource.data.projectId);
      allow update: if isOwner(resource.data.userId) || 
                       canModifyProject(resource.data.projectId);
    }
    
    // Workflow Templates (Unified)
    match /workflow-templates/{templateId} {
      // Allow authenticated users to read/write
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Workflow Instances (Unified) - kebab-case collection name
    match /workflow-instances/{instanceId} {
      // Allow authenticated users to read/write their own instances
      // Or if they belong to the organization
      allow read: if isAuthenticated() && (
        !('createdBy' in resource.data) ||
        resource.data.createdBy == request.auth.uid ||
        !('organizationId' in resource.data) ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        !('createdBy' in resource.data) ||
        resource.data.createdBy == request.auth.uid ||
        !('organizationId' in resource.data) ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        !('createdBy' in resource.data) ||
        resource.data.createdBy == request.auth.uid ||
        !('organizationId' in resource.data) ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
    }
    
    // Workflow Instances (Unified) - camelCase collection name (alternative)
    match /workflowInstances/{instanceId} {
      // Allow authenticated users to read/write their own instances
      allow read: if isAuthenticated() && (
        !('createdBy' in resource.data) ||
        resource.data.createdBy == request.auth.uid ||
        !('organizationId' in resource.data) ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        !('createdBy' in resource.data) ||
        resource.data.createdBy == request.auth.uid ||
        !('organizationId' in resource.data) ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        !('createdBy' in resource.data) ||
        resource.data.createdBy == request.auth.uid ||
        !('organizationId' in resource.data) ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
    }
    
    // Timecard Templates
    match /timecardTemplates/{templateId} {
      allow read: if belongsToOrganization(resource.data.organizationId);
      allow create: if belongsToOrganization(request.resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow update: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow delete: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin']);
    }
    
    // Timecard Assignments
    match /timecardAssignments/{assignmentId} {
      allow read: if belongsToOrganization(resource.data.organizationId);
      allow create: if belongsToOrganization(request.resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow update: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow delete: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin']);
    }
    
    // Timecard Configurations
    match /timecardConfigurations/{configId} {
      allow read: if belongsToOrganization(resource.data.organizationId);
      allow create: if belongsToOrganization(request.resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow update: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow delete: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin']);
    }
    
    // Inventory Items
    match /inventoryItems/{itemId} {
      allow read: if canAccessProject(resource.data.projectId);
      allow write: if canModifyProject(resource.data.projectId);
    }
    
    // Reports
    match /reports/{reportId} {
      allow read: if canAccessProject(resource.data.projectId);
      allow create: if canAccessProject(request.resource.data.projectId);
      allow update: if isOwner(resource.data.userId) || 
                       canModifyProject(resource.data.projectId);
    }
    
    // Notifications
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if true; // System can create notifications
      allow update: if isOwner(resource.data.userId);
    }
    
    // ============================================================================
    // LICENSING WEBSITE COLLECTIONS
    // ============================================================================
    
    // Licenses - Enhanced license validation with claims
    match /licenses/{licenseId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        (isAuthenticated() && resource.data.userId == request.auth.uid) ||
        isAuthenticated()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin']) ||
        (isAuthenticated() && request.resource.data.userId == request.auth.uid)
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin']) ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin'])
      );
    }
    
    // Subscriptions - Admin access for dashboard stats
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin']) ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin']) ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin'])
      );
    }
    
    // Standalone Licenses - Enhanced license validation
    match /standaloneLicenses/{licenseId} {
      allow read: if isAuthenticated() && (
        isAuthenticated() ||
        resource.data.userId == request.auth.uid ||
        hasAnyRole(['OWNER', 'ADMIN'])
      );
      allow create: if isAuthenticated() && (
        isAuthenticated() && 
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasAnyRole(['OWNER', 'ADMIN'])
      );
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasAnyRole(['OWNER', 'ADMIN'])
      );
    }
    
    // ============================================================================
    // CALL SHEET APP COLLECTIONS
    // ============================================================================
    
    // Call sheets collection
    match /callsheetCallSheets/{callSheetId} {
      allow read, write: if isAuthenticated();
    }
    
    // Legacy callsheets collection (for dashboard integration)
    match /callsheets/{callSheetId} {
      allow read, write: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
    }
    
    // Personnel collection
    match /callsheetPersonnel/{personnelId} {
      allow read, write: if isAuthenticated();
    }
    
    // Templates collection
    match /callsheetTemplates/{templateId} {
      allow read, write: if isAuthenticated();
    }
    
    // Published call sheets collection
    match /callsheetPublishedCallSheets/{publishId} {
      allow read, write: if isAuthenticated();
    }
    
    // Call sheet links collection
    match /callsheetLinks/{linkId} {
      allow read: if true; // Public read access for published links
      allow write: if isAuthenticated();
    }
    
    // Daily call sheet records collection - user-specific access
    match /callsheetDailyRecords/{recordId} {
      allow read, write: if isAuthenticated();
      allow create: if isAuthenticated();
    }
    
    // Legacy daily call sheets collection (for dashboard integration)
    match /dailyCallSheets/{recordId} {
      allow read, write: if isAuthenticated();
    }
    
    // Message sessions collection - for chat functionality
    match /messageSessions/{sessionId} {
      allow read, write: if isAuthenticated() 
        && belongsToOrganization(resource.data.organizationId)
        && request.auth.uid in resource.data.participantIds;
      allow create: if isAuthenticated() 
        && belongsToOrganization(request.resource.data.organizationId)
        && request.auth.uid in request.resource.data.participantIds;
    }
    
    // Messages collection - for chat messages
    match /messages/{messageId} {
      allow read, write: if isAuthenticated() 
        && belongsToOrganization(resource.data.organizationId)
        && request.auth.uid == resource.data.senderId;
      allow create: if isAuthenticated() 
        && belongsToOrganization(request.resource.data.organizationId)
        && request.auth.uid == request.resource.data.senderId;
    }
    
    // Conversations collection - for Clip Show Pro messaging system
    match /conversations/{conversationId} {
      // Allow read if user is a participant and belongs to organization
      allow read: if isAuthenticated() 
        && belongsToOrganization(resource.data.organizationId)
        && request.auth.uid in resource.data.participants;
      
      // Allow create if user is in participants list and belongs to organization
      allow create: if isAuthenticated() 
        && belongsToOrganization(request.resource.data.organizationId)
        && request.auth.uid in request.resource.data.participants;
      
      // Allow update if user is a participant
      allow update: if isAuthenticated() 
        && belongsToOrganization(resource.data.organizationId)
        && request.auth.uid in resource.data.participants;
      
      // Allow delete if user is the creator or an admin
      allow delete: if isAuthenticated() 
        && (request.auth.uid == resource.data.createdBy || isOwnerOrAdmin());
      
      // Messages subcollection
      match /messages/{messageId} {
        // Allow read if user is a conversation participant
        allow read: if isAuthenticated() 
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        // Allow create if user is sender and a conversation participant
        allow create: if isAuthenticated() 
          && request.auth.uid == request.resource.data.senderId
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        // Allow update if:
        // 1. User is the sender (for editing/deleting), OR
        // 2. User is a participant and only updating readBy field (for marking as read)
        allow update: if isAuthenticated() &&
          (
            request.auth.uid == resource.data.senderId ||
            (
              request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants &&
              request.resource.data.readBy is list &&
              request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']) &&
              request.resource.data.conversationId == resource.data.conversationId &&
              request.resource.data.senderId == resource.data.senderId &&
              request.resource.data.text == resource.data.text &&
              request.resource.data.createdAt == resource.data.createdAt
            )
          );
        
        // Allow delete if user is the sender
        allow delete: if isAuthenticated() 
          && request.auth.uid == resource.data.senderId;
      }
      
      // Typing indicators subcollection
      match /typingIndicators/{userId} {
        // Allow read if user is a conversation participant
        allow read: if isAuthenticated() 
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        // Allow write only for own typing indicator
        allow write: if isAuthenticated() 
          && request.auth.uid == userId
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      }
    }
    
    // ============================================================================
    // EDL CONVERTER COLLECTIONS
    // ============================================================================
    
    // EDL Files - EDL file data for standalone converter
    match /edlFiles/{fileId} {
      allow read: if isAuthenticated() && hasEDLConverterAccess();
      allow create: if isAuthenticated() && hasEDLConverterAccess();
      allow update: if isAuthenticated() && hasEDLConverterAccess();
      allow delete: if isAuthenticated() && hasEDLConverterAccess();
    }
    
    // EDL File Metadata - Metadata for chunked files
    match /edlFileMetadata/{document} {
      allow read: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // EDL File Chunks - Chunked data for large files
    match /edlFileChunks/{document} {
      allow read: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // EDL Projects - EDL project management
    match /edlProjects/{projectId} {
      allow read: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // ============================================================================
    // PARSER BRAIN COLLECTIONS
    // ============================================================================
    
    // Parsing patterns
    match /parsing-patterns/{patternId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && hasMinimumHierarchy(50);
    }
    
    // Pattern statistics
    match /pattern-statistics/{statId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && hasMinimumHierarchy(50);
    }
    
    // Pattern submissions
    match /pattern-submissions/{submissionId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ============================================================================
    // SYSTEM COLLECTIONS
    // ============================================================================
    
    // System Configuration - Global system settings and collection metadata
    match /_system/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        hasAnyRole(['OWNER', 'ADMIN']) || 
        hasAnyOrgRole(['owner', 'admin']) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Health Monitoring - System health and status
    match /_health/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        hasAnyRole(['OWNER', 'ADMIN']) || 
        hasAnyOrgRole(['owner', 'admin'])
      );
    }
    
    // ============================================================================
    // GENERIC COLLECTIONS
    // ============================================================================
    
    // Project Data - Project-specific data container
    match /projectData/{dataId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // MAP AND LAYOUT COLLECTIONS
    // ============================================================================
    
    // Map Layouts - Map layout definitions
    match /mapLayouts/{mapLayoutId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Map Locations - Map location data
    match /mapLocations/{mapLocationId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Map Data - General map data
    match /mapData/{mapDataId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // PBM (PROJECT BUDGET MANAGEMENT) COLLECTIONS
    // ============================================================================
    
    // PBM Projects - Project budget management
    match /pbmProjects/{projectId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // PBM Schedules - Budget schedules
    match /pbmSchedules/{scheduleId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // PBM Payscales - Pay scale configurations
    match /pbmPayscales/{payscaleId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // PBM Daily Status - Daily status tracking
    match /pbmDailyStatus/{statusId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Production Sessions - Production session data
    match /productionSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // TIMECARD COLLECTIONS
    // ============================================================================
    
    // User Timecards - Main timecard records
    match /user_timecards/{timecardId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Timecard Entries - Individual clock in/out entries
    match /timecard_entries/{entryId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Timecard Approvals - Approval workflow records
    match /timecard_approvals/{approvalId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.employeeId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.employeeId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Timecard Templates - Template configurations
    match /timecard_templates/{templateId} {
      allow read: if isAuthenticated() && (
        resource.data.isPublic == true ||
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // SCHEDULER COLLECTIONS
    // ============================================================================
    
    // Scheduler Events - Calendar events and scheduling
    match /schedulerEvents/{eventId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Scheduler Event Assignments - Event assignment data
    match /schedulerEventAssignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // NOTES COLLECTION
    // ============================================================================
    
    // Notes - User notes and annotations
    match /notes/{noteId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // MEDIA FILES COLLECTION
    // ============================================================================
    
    // Media files - organization-scoped with proper access control
    match /mediaFiles/{mediaFileId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.uploadedBy == request.auth.uid ||
        isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.uploadedBy == request.auth.uid ||
        isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          resource.data.uploadedBy == request.auth.uid ||
          isOwnerOrAdmin()
        ) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          resource.data.uploadedBy == request.auth.uid ||
          isOwnerOrAdmin()
        ) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // CLIP SHOW PRO COLLECTIONS
    // ============================================================================
    
    // Clip Show Pro Pitches - Pitch data for review
    match /clipShowPitches/{pitchId} {
      allow read: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if hasClipShowProAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Clip Show Pro Licenses - License agreements
    match /clipShowLicenses/{licenseId} {
      allow read: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if hasClipShowProAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Clip Show Pro Stories - Production stories
    match /clipShowStories/{storyId} {
      allow read: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if hasClipShowProAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Clip Show Pro Shows - Show management
    match /clipShowShows/{showId} {
      allow read: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if hasClipShowProAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Clip Show Pro Seasons - Season management
    match /clipShowSeasons/{seasonId} {
      allow read: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if hasClipShowProAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Clip Show Pro Comments - Pitch comments with mentions
    match /clipShowComments/{commentId} {
      allow read: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if hasClipShowProAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if hasClipShowProAccess() && (
        resource.data.userId == request.auth.uid ||
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()
      );
      allow delete: if hasClipShowProAccess() && (
        resource.data.userId == request.auth.uid ||
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()
      );
    }
    
    // Clip Show Pro Notes - User personal notes (tenant-aware, user-specific)
    // CRITICAL: Notes are user-specific and must only be accessible by the creator
    match /clipShowNotes/{noteId} {
      // Read: Only the user who created the note can read it
      allow read: if hasClipShowProAccess() && (
        resource.data.userId == request.auth.uid &&
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      // Create: User can create notes in their organization
      allow create: if hasClipShowProAccess() && (
        request.resource.data.userId == request.auth.uid &&
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      // Update: Only the user who created the note can update it
      allow update: if hasClipShowProAccess() && (
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == request.auth.uid &&
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      // Delete: Only the user who created the note can delete it
      allow delete: if hasClipShowProAccess() && (
        resource.data.userId == request.auth.uid &&
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Clip Show Pro Documents - Document references (Google Docs, Box)
    match /clipShowDocuments/{documentId} {
      allow read: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if hasClipShowProAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Clip Show Pro Script Templates - Script templates
    match /clipShowScriptTemplates/{templateId} {
      allow read: if hasClipShowProAccess() && (
        resource.data.isPublic == true ||
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if hasClipShowProAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Clip Show Pro Licensing Specialists - Licensing specialist assignments
    match /clipShowLicensingSpecialists/{specialistId} {
      allow read: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if hasClipShowProAccess() && (
        belongsToOrganization(request.resource.data.organizationId) && isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
      allow update: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Clip Show Pro Contacts - Production contact management
    match /clipShowContacts/{contactId} {
      allow read: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if hasClipShowProAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if hasClipShowProAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // CLIP SHOW PRO COLLECTIONS
    // ============================================================================
    
    // Projects collection - organization-scoped project metadata
    match /clipShowProjects/{projectId} {
      allow read: if belongsToOrganization(resource.data.organizationId);
      allow create: if isAuthenticated() && request.resource.data.organizationId == getOrganizationId();
      allow update, delete: if belongsToOrganization(resource.data.organizationId) && 
        (isOwnerOrAdmin() || resource.data.createdBy == request.auth.uid);
    }
    
    // Folders collection - project organization structure
    match /clipShowFolders/{folderId} {
      allow read: if belongsToOrganization(resource.data.organizationId);
      allow write: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
    }
    
    // Budget metadata collection - budget summaries and group metadata
    match /clipShowBudgetMetadata/{budgetId} {
      allow read: if belongsToOrganization(resource.data.organizationId) && 
        canAccessProject(resource.data.projectId);
      allow write: if isAuthenticated() && canModifyProject(request.resource.data.projectId);
    }
    
    // Indexed files collection - file/folder metadata for media indexing
    match /clipShowIndexedFiles/{fileId} {
      allow read: if belongsToOrganization(resource.data.organizationId);
      allow write: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
    }
    
    // Parsed files collection - EDL parsing metadata with Storage URLs
    match /clipShowParsedFiles/{fileId} {
      allow read: if belongsToOrganization(resource.data.organizationId) && 
        canAccessProject(resource.data.projectId);
      allow write: if isAuthenticated() && canModifyProject(request.resource.data.projectId);
    }
    
    // Cloud Integrations - OAuth tokens and integration settings
    match /cloudIntegrations/{integrationId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // OAuth States - Temporary state storage for OAuth flows
    match /oauthStates/{stateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Integration tokens - organization scoped, encrypted
    match /organizations/{orgId}/integrations/{integrationId} {
      // Members can read their org's integrations (tokens are encrypted)
      allow read: if belongsToOrganization(orgId);
      
      // Only admins can create/update integrations
      allow create, update: if belongsToOrganization(orgId) && isOwnerOrAdmin();
      
      // Only admins can delete integrations
      allow delete: if belongsToOrganization(orgId) && isOwnerOrAdmin();
      
      // Validate integration structure
      allow write: if request.resource.data.keys().hasAll([
        'provider', 'userId', 'organizationId', 'tokens'
      ]) && request.resource.data.organizationId == orgId;
    }
    
    // ============================================================================
    // COLLECTION GROUP QUERIES - For Ecosystem-Wide Data Access
    // ============================================================================
    // These rules allow collectionGroup queries across the entire database
    // for specific collections, enabling cross-app relationship graph queries
    
    // Post-Production Tasks - Allow collectionGroup queries for user activity
    match /{path=**}/postProductionTasks/{taskId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // Checkout Records (IWM) - Allow collectionGroup queries for equipment tracking
    match /{path=**}/checkoutRecords/{recordId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow if user is the one who checked out the item
        (resource != null && resource.data != null && 
         (resource.data.userId == request.auth.uid || 
          resource.data.checkedOutBy == request.auth.uid)) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // Network Devices (IWM) - Allow collectionGroup queries for device management
    match /{path=**}/networkDevices/{deviceId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow if user is assigned to the device
        (resource != null && resource.data != null && 
         (resource.data.assignedTo == request.auth.uid || 
          resource.data.managedBy == request.auth.uid)) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // Call Sheets - Allow collectionGroup queries for production schedules
    match /{path=**}/callSheets/{sheetId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow if user created the call sheet
        (resource != null && resource.data != null && 
         resource.data.userId == request.auth.uid) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // Team Members - Allow collectionGroup queries for user search
    match /{path=**}/teamMembers/{memberId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // Pitches - Allow collectionGroup queries for content discovery
    match /{path=**}/pitches/{pitchId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow if user created the pitch
        (resource != null && resource.data != null && 
         resource.data.userId == request.auth.uid) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // Stories - Allow collectionGroup queries for content discovery
    match /{path=**}/stories/{storyId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow if user created the story
        (resource != null && resource.data != null && 
         resource.data.userId == request.auth.uid) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // Inventory - Allow collectionGroup queries for asset tracking
    match /{path=**}/inventory/{inventoryId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // Sessions - Allow collectionGroup queries for production tracking
    match /{path=**}/sessions/{sessionId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow if user created the session
        (resource != null && resource.data != null && 
         resource.data.userId == request.auth.uid) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // ClipPitches - Allow collectionGroup queries for content discovery
    match /{path=**}/clipPitches/{pitchId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow if user created the pitch or is assigned as producer
        (resource != null && resource.data != null && 
         (resource.data.userId == request.auth.uid || 
          resource.data.producerId == request.auth.uid ||
          resource.data.assignedProducerId == request.auth.uid)) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // ProductionStories - Allow collectionGroup queries for content discovery
    match /{path=**}/productionStories/{storyId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow if user created or is writer of the story
        (resource != null && resource.data != null && 
         (resource.data.userId == request.auth.uid || 
          resource.data.writerId == request.auth.uid)) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // Timecards - Allow collectionGroup queries for timecard tracking
    match /{path=**}/timecards/{timecardId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow if user owns the timecard
        (resource != null && resource.data != null && 
         resource.data.userId == request.auth.uid) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // ClipShowCalendarEvents - Allow collectionGroup queries for calendar access
    match /{path=**}/clipShowCalendarEvents/{eventId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // CueSheets - Allow collectionGroup queries for music licensing
    match /{path=**}/cueSheets/{cueSheetId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // BudgetValues - Allow collectionGroup queries for budget tracking
    match /{path=**}/budgetValues/{budgetId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // ProjectSessions - Allow collectionGroup queries for session tracking
    match /{path=**}/projectSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // LicenseAgreements - Allow collectionGroup queries for licensing
    match /{path=**}/licenseAgreements/{agreementId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // CalendarEvents - Allow collectionGroup queries (already have specific rules, adding general)
    match /{path=**}/calendarEvents/{eventId} {
      allow read: if isAuthenticated() && (
        // Allow if document belongs to user's organization
        (resource != null && resource.data != null && 
         resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Allow admins
        isOwnerOrAdmin()
      );
    }
    
    // ============================================================================
    
    // Explicit deny for unmatched paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
